<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="爱自然书店管理系统">

  <!-- 添加缓存控制 -->
  <meta http-equiv="Cache-Control" content="max-age=3600">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="book_store_admin">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>爱自然书店管理系统</title>
  <link rel="manifest" href="manifest.json">

  <!-- 在 head 标签中添加 -->
  <meta name="referrer" content="no-referrer">
  
  <!-- 添加 CORS 配置 -->
  <meta http-equiv="Content-Security-Policy" content="img-src * 'self' data: https:;">
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src * self blob: data: gap:; style-src * self 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * self 'unsafe-inline' blob: data: gap:; connect-src self * 'unsafe-inline' blob: data: gap:; frame-src * self blob: data: gap:;"> -->

  <!-- 添加跨域资源共享策略 -->
  <meta http-equiv="Cross-Origin-Resource-Policy" content="cross-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">

  <!-- 预加载字体资源，提供多字重支持 -->
  
  <!-- 预加载主要JavaScript文件 -->
  <link rel="preload" href="main.dart.js" as="script">
  <link rel="preload" href="flutter.js" as="script">
  
  <!-- 预加载Google Fonts字体 --> 
  <link rel="preload" href="https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhLOCT-xWNm8Hqd37g1OkDRZe7lR4sg1IzSy-MNbE9VH8V.0.woff2" as="font" crossorigin> 
  <link rel="preload" href="https://fonts.gstatic.com/s/notosanssc/v36/k3kIo84MPvpLmixcA63oeALhL4iJ-Q7m8w9BOYQAiUJ-8hFUEVxKXcfGFmE.0.woff2" as="font" crossorigin> 
  <link rel="preload" href="https://fonts.gstatic.com/s/notosanssc/v36/k3kCo84MPvpLmixcA63oeALhLOCT-xWNm8Hqd37g1OkDRZe7lR4sg1IzSy-MNbE9VH8V.0.woff2" as="font" crossorigin>  <style>
    /* 系统字体回退策略 */
    
    
    
    /* 添加拉丁字符子集 */
    
    /* 为了兼容性，创建Noto Sans SC的别名 */
    
    /* 使用Google Fonts CDN加载Noto Sans SC字体 */ 
    @font-face { 
      font-family: "NotoSansSC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      font-style: normal; 
      font-weight: 400; 
      font-display: swap; 
      src: url(https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhLOCT-xWNm8Hqd37g1OkDRZe7lR4sg1IzSy-MNbE9VH8V.0.woff2) format("woff2"); 
      unicode-range: U+4E00-9FFF, U+3400-4DBF; 
    } 
    
    @font-face { 
      font-family: "NotoSansSC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      font-style: normal; 
      font-weight: 500; 
      font-display: swap; 
      src: url(https://fonts.gstatic.com/s/notosanssc/v36/k3kIo84MPvpLmixcA63oeALhL4iJ-Q7m8w9BOYQAiUJ-8hFUEVxKXcfGFmE.0.woff2) format("woff2"); 
      unicode-range: U+4E00-9FFF, U+3400-4DBF; 
    } 
    
    @font-face { 
      font-family: "NotoSansSC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      font-style: normal; 
      font-weight: 700; 
      font-display: swap; 
      src: url(https://fonts.gstatic.com/s/notosanssc/v36/k3kCo84MPvpLmixcA63oeALhLOCT-xWNm8Hqd37g1OkDRZe7lR4sg1IzSy-MNbE9VH8V.0.woff2) format("woff2"); 
      unicode-range: U+4E00-9FFF, U+3400-4DBF; 
    } 
    
    @font-face { 
      font-family: "NotoSansSC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      font-style: normal; 
      font-weight: 400; 
      font-display: swap; 
      src: url(https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhL4iJ-Q7m8w9BOYQAiUJ-8hFUEVxKXcfGFmE.0.woff2) format("woff2"); 
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD; 
    }    body {
      font-family: "NotoSansSC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    
    /* 骨架屏样式 */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      z-index: 9999;
    }
    
    .skeleton-header {
      height: 64px;
      background: linear-gradient(90deg, #0078D4 0%, #268CDC 100%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      padding: 0 24px;
      position: relative;
    }
    
    .skeleton-logo {
      height: 36px;
      width: 200px;
      background-color: rgba(255,255,255,0.3);
      border-radius: 4px;
    }
    
    .skeleton-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .skeleton-sidebar {
      width: 240px;
      background-color: #f0f0f0;
      padding: 20px 0;
      box-shadow: 1px 0 5px rgba(0,0,0,0.05);
    }
    
    .skeleton-menu-item {
      height: 18px;
      margin: 16px 20px;
      background-color: #ddd;
      border-radius: 4px;
      opacity: 0.7;
    }
    
    .skeleton-main {
      flex: 1;
      padding: 24px;
      display: flex;
      flex-direction: column;
    }
    
    .skeleton-title {
      height: 28px;
      width: 200px;
      background-color: #ddd;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    
    .skeleton-card {
      height: 120px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 16px;
    }
    
    .skeleton-text {
      height: 14px;
      background-color: #eee;
      border-radius: 2px;
      margin-bottom: 12px;
    }
    
    .shimmer {
      background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 24px;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(0, 120, 212, 0.2);
      border-top-color: #0078D4;
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- 添加骨架屏 -->
  <div id="loading">
    <div class="skeleton-header">
      <div class="skeleton-logo shimmer"></div>
    </div>
    <div class="skeleton-content">
      <div class="skeleton-sidebar">
        <div class="skeleton-menu-item shimmer"></div>
        <div class="skeleton-menu-item shimmer"></div>
        <div class="skeleton-menu-item shimmer"></div>
        <div class="skeleton-menu-item shimmer"></div>
        <div class="skeleton-menu-item shimmer"></div>
        <div class="skeleton-menu-item shimmer"></div>
      </div>
      <div class="skeleton-main">
        <div class="skeleton-title shimmer"></div>
        <div class="skeleton-card">
          <div class="skeleton-text shimmer" style="width: 60%"></div>
          <div class="skeleton-text shimmer" style="width: 80%"></div>
          <div class="skeleton-text shimmer" style="width: 40%"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton-text shimmer" style="width: 70%"></div>
          <div class="skeleton-text shimmer" style="width: 50%"></div>
          <div class="skeleton-text shimmer" style="width: 60%"></div>
        </div>
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Flutter 加载脚本 -->
  <script src="flutter.js" defer></script>
  
  <script>
    // 性能监控
    const perfEntries = {};
    
    // 记录性能指标
    function recordPerfMetric(name, value) {
      perfEntries[name] = value;
      console.log(`性能指标 - ${name}: ${value}ms`);
    }
    
    // 初始加载时间戳
    const initialLoadTime = performance.now();
    
    window.addEventListener('load', function() {
      // 记录页面加载时间
      recordPerfMetric('页面加载时间', performance.now() - initialLoadTime);
      
      // 从本地保存的时间戳判断是否已有缓存
      const cachedTime = localStorage.getItem('flutterAppCachedTime');
      const currentTime = new Date().getTime();
      
      // 检测字体是否已加载
      document.fonts.ready.then(function() {
        console.log('字体已加载完成');
        recordPerfMetric('字体加载时间', performance.now() - initialLoadTime);
      });
      
      // 加载Flutter引擎
      _flutter = {};
      _flutter.loader = _flutter.loader || {};
      _flutter.loader.loadEntrypoint = function(options) {
        // 使用自适应渲染策略
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const preferredRenderer = isMobile ? "html" : "canvaskit";
        
        console.log(`使用渲染器: ${preferredRenderer}`);
        
        const engineLoadStart = performance.now();
        
        return flutter.loader.loadEntrypoint({
          ...options,
          serviceWorker: {
            serviceWorkerVersion: serviceWorkerVersion,
          },
          onEntrypointLoaded: async function(engineInitializer) {
            recordPerfMetric('引擎加载时间', performance.now() - engineLoadStart);
            
            const appInitStart = performance.now();
            let appRunner = await engineInitializer.initializeEngine({
              renderer: preferredRenderer,
              useColorEmoji: true,
              // 自定义CanvasKit配置
              canvasKitVariant: "full", // 使用完整版CanvasKit以支持中文
              canvasKitMaximumSurfaces: 8, // 限制最大表面数量以节省内存
            });
            
            recordPerfMetric('引擎初始化时间', performance.now() - appInitStart);
            
            const appStartTime = performance.now();
            await appRunner.runApp();
            recordPerfMetric('应用启动时间', performance.now() - appStartTime);
            recordPerfMetric('总启动时间', performance.now() - initialLoadTime);
            
            // 移除加载界面
            setTimeout(function() {
              const loadingElement = document.getElementById('loading');
              if (loadingElement) {
                loadingElement.style.opacity = '0';
                loadingElement.style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                  loadingElement.remove();
                }, 500);
              }
            }, 200);
            
            // 保存缓存时间戳
            localStorage.setItem('flutterAppCachedTime', currentTime);
            
            // 延迟加载非关键资源
            setTimeout(function() {
              // 预取可能需要的资源
              const links = [
                // 添加您的应用可能需要的其他资源
              ];
              
              for (const url of links) {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = url;
                document.head.appendChild(link);
              }
            }, 3000); // 延迟3秒加载非关键资源
          }
        });
      };
      
      // 创建window.flutterConfiguration对象
      window.flutterConfiguration = {
        canvasKitBaseUrl: "/canvaskit/",
        // 添加自定义CanvasKit加载策略
        canvasKitForceCachingFonts: true
      };
      
      // 使用requestIdleCallback延迟加载主应用（如果浏览器支持）
      const loadMainDartJs = () => {
        const scriptTag = document.createElement('script');
        scriptTag.src = 'main.dart.js';
        scriptTag.type = 'application/javascript';
        document.body.appendChild(scriptTag);
      };
      
      if ('requestIdleCallback' in window) {
        // 在浏览器空闲时加载应用
        requestIdleCallback(loadMainDartJs, { timeout: 2000 });
      } else {
        // 回退方案
        setTimeout(loadMainDartJs, 100);
      }
    });
    
    // 监听资源加载错误
    window.addEventListener('error', function(e) {
      if (e.target.tagName === 'LINK' && e.target.rel === 'preload') {
        console.warn('字体资源加载失败:', e.target.href);
        // 字体资源加载失败时使用系统字体
      }
    }, true);
    
    // 添加性能监控
    if ('PerformanceObserver' in window) {
      // 监控长任务
      const longTaskObserver = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          console.warn(`检测到长任务: ${entry.duration}ms`);
        }
      });
      
      longTaskObserver.observe({entryTypes: ['longtask']});
      
      // 监控布局偏移
      const layoutShiftObserver = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput) {
            console.warn(`布局偏移: ${entry.value}`);
          }
        }
      });
      
      if (PerformanceObserver.supportedEntryTypes.includes('layout-shift')) {
        layoutShiftObserver.observe({entryTypes: ['layout-shift']});
      }
    }
  </script>
</body>
</html>
