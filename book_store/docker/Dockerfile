# syntax=docker/dockerfile:1.4

# ğŸ› ï¸ **æ„å»ºé˜¶æ®µ**
# ğŸ”¥ ä½¿ç”¨é»˜è®¤å¹³å°ï¼Œä½†åœ¨ `buildx` è¿è¡Œæ—¶æ­£ç¡®è§£æ
# æœ¬åœ°æ„å»ºæ—¶ï¼ŒBUILDPLATFORM ä¸ºç©ºï¼Œé»˜è®¤ç”¨ linux/amd64ï¼ˆé€‚é… buildxï¼‰ã€‚
# è¿œç¨‹ buildx è¿è¡Œæ—¶ï¼ŒDocker ä¼šè‡ªåŠ¨æ›¿æ¢ BUILDPLATFORMï¼Œç¡®ä¿æ­£ç¡®çš„æ¶æ„ã€‚
# FROM dart:3.3.0 AS build
# FROM --platform=$BUILDPLATFORM dart:3.3.0 AS build
ARG BUILDPLATFORM
FROM --platform=${BUILDPLATFORM:-linux/amd64} dart:3.3.0 AS build

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æºç 
COPY . book_store_server book_store_server/
COPY . book_store_shared book_store_shared/

# è¿›å…¥æœåŠ¡å™¨ç›®å½•
WORKDIR /app/book_store_server


# è·å–ä¾èµ–
RUN dart pub get

# ğŸš€ ç¼–è¯‘æˆ Linux å¯æ‰§è¡Œæ–‡ä»¶
RUN dart compile exe bin/main.dart -o bin/server --target-os=linux

# ğŸ—ï¸ **è¿è¡Œæ—¶é˜¶æ®µ**
FROM --platform=$TARGETPLATFORM alpine:3.19

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN --mount=type=cache,target=/var/cache/apk \
    apk add --no-cache \
    ca-certificates \
    curl

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV runmode=production
ENV serverid=default
ENV logging=normal
ENV role=monolith

# å¤åˆ¶ Dart è¿è¡Œæ—¶ï¼ˆå¦‚æœæœ‰ï¼‰
COPY --from=build /runtime/ /

# å¤åˆ¶ç¼–è¯‘åçš„ `server` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ å¤åˆ¶é…ç½®ã€é™æ€æ–‡ä»¶ã€æ•°æ®åº“è¿ç§»
COPY --from=build /app/book_store_server/bin/server /app/server
# COPY --from=build /app/book_store_server/config/ /app/config/
# COPY --from=build /app/book_store_server/web/ /app/web/
# COPY --from=build /app/book_store_server/migrations/ /app/migrations/
COPY --from=build /app/book_store_server/confi[g]/ config/
COPY --from=build /app/book_store_server/we[b]/ web/
COPY --from=build /app/book_store_server/migration[s]/ migrations/

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# æš´éœ²ç«¯å£
EXPOSE 8080
EXPOSE 8081
EXPOSE 8082

# å…¥å£å‘½ä»¤ï¼Œåº”ç”¨æ•°æ®åº“è¿ç§»å¹¶å¯åŠ¨æœåŠ¡å™¨
ENTRYPOINT /app/server \
  --apply-migrations \
  --mode=${runmode} \
  --server-id=${serverid} \
  --logging=${logging} \
  --role=${role}



