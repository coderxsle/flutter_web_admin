# 时区配置问题演示

## 场景1：只使用环境变量

```yaml
# docker-compose-simple.yaml
postgres:
  environment:
    TZ: Asia/Shanghai
    PGTZ: Asia/Shanghai
```

**可能的问题：**

### 问题1：PostgreSQL重启后时区重置
```bash
# 启动容器
docker-compose up -d

# 检查时区（可能正确）
docker exec postgres psql -c "SHOW timezone;"
# 输出：Asia/Shanghai

# 重启PostgreSQL服务
docker exec postgres pg_ctl restart

# 再次检查时区（可能变成UTC）
docker exec postgres psql -c "SHOW timezone;"
# 输出：UTC  <- 问题！
```

### 问题2：数据库连接池重置
```bash
# 某些操作可能导致连接池重置
docker exec postgres psql -c "SELECT pg_reload_conf();"

# 时区可能重置为默认值
docker exec postgres psql -c "SHOW timezone;"
# 输出：UTC  <- 问题！
```

### 问题3：容器重启
```bash
# 重启整个容器
docker-compose restart postgres

# 时区设置可能丢失
docker exec postgres psql -c "SHOW timezone;"
# 输出：UTC  <- 问题！
```

## 场景2：使用完整配置

```yaml
# docker-compose.prod.yaml
postgres:
  environment:
    TZ: Asia/Shanghai
    PGTZ: Asia/Shanghai
  volumes:
    - ./init-timezone.sql:/docker-entrypoint-initdb.d/01-init-timezone.sql
  command: >
    postgres
    -c timezone=Asia/Shanghai
    -c log_timezone=Asia/Shanghai
```

**优势：**

### 优势1：初始化脚本确保设置
```sql
-- init-timezone.sql
SET timezone = 'Asia/Shanghai';
ALTER SYSTEM SET timezone = 'Asia/Shanghai';
SELECT pg_reload_conf();
```

### 优势2：启动参数强制设置
```bash
# 每次启动都会应用这些参数
postgres -c timezone=Asia/Shanghai -c log_timezone=Asia/Shanghai
```

### 优势3：配置持久化
```bash
# 即使重启，时区设置也会保持
docker-compose restart postgres
docker exec postgres psql -c "SHOW timezone;"
# 输出：Asia/Shanghai  <- 正确！
```

## 实际影响

### 对应用程序的影响

```dart
// 在您的Serverpod应用中
var user = await SysUser.db.findById(session, userId);

// 如果时区设置不正确，时间可能显示错误
print(user?.loginTime);  // 可能显示UTC时间而不是本地时间
```

### 对数据库查询的影响

```sql
-- 时区错误可能导致查询结果不准确
SELECT * FROM sys_user WHERE login_time > '2025-01-01 00:00:00';
-- 如果时区是UTC，这个查询可能包含或排除错误的数据
```

## 验证方法

### 检查时区设置
```bash
# 进入PostgreSQL容器
docker exec -it postgres bash

# 检查当前时区
psql -U postgres -c "SHOW timezone;"

# 检查当前时间
psql -U postgres -c "SELECT now();"

# 检查系统时区
date
```

### 检查时区是否持久
```bash
# 重启PostgreSQL服务
docker exec postgres pg_ctl restart

# 再次检查时区
psql -U postgres -c "SHOW timezone;"

# 如果还是Asia/Shanghai，说明配置持久
# 如果变成UTC，说明配置不够持久
```




