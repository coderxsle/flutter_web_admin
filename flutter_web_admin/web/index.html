<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="example">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>example</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- é˜»æ­¢ Google Fonts è¯·æ±‚ - ä½¿ç”¨ CSP
  <meta http-equiv="Content-Security-Policy" content="font-src 'self' data: blob:;"> -->
  
  <!-- é¢„åŠ è½½å­—ä½“ - æé«˜å­—ä½“åŠ è½½ä¼˜å…ˆçº§ (web/fonts ç›®å½•ä¼šç›´æ¥å¤åˆ¶åˆ°æ„å»ºæ ¹ç›®å½•) -->
  <link rel="preload" href="fonts/NotoSansSC-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin>
  
  <style>
    /* å®šä¹‰å­—ä½“ - ä½¿ç”¨ font-display: swap é˜²æ­¢æ–‡å­—é—ªçƒ */
    @font-face {
      font-family: 'NotoSansSC';
      src: url('fonts/NotoSansSC-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap; /* å…ˆæ˜¾ç¤ºç³»ç»Ÿå­—ä½“ï¼Œå­—ä½“åŠ è½½å®Œåå†åˆ‡æ¢ */
    }
    
    @font-face {
      font-family: 'Roboto';
      src: url('fonts/Roboto-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    
    @font-face {
      font-family: 'Roboto';
      src: url('fonts/Roboto-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
      transition: opacity 0.8s ease-out;
    }

    #loading-container.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    /* ç²’å­èƒŒæ™¯ */
    #particles-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* ä¸»åŠ è½½å™¨å®¹å™¨ */
    .loader-wrapper {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
    }

    /* 3Dæ—‹è½¬ç¯ */
    .rings-container {
      position: relative;
      width: 200px;
      height: 200px;
      perspective: 1000px;
    }

    .ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-style: preserve-3d;
      border-radius: 50%;
      border: 3px solid transparent;
      animation: rotate3d 3s infinite linear;
    }

    /* å¤–ç¯ */
    .ring-1 {
      width: 200px;
      height: 200px;
      margin: -100px 0 0 -100px;
      border-color: rgba(99, 102, 241, 0.8);
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.6), inset 0 0 30px rgba(99, 102, 241, 0.3);
      animation-duration: 6s;
    }

    /* ä¸­ç¯ */
    .ring-2 {
      width: 160px;
      height: 160px;
      margin: -80px 0 0 -80px;
      border-color: rgba(139, 92, 246, 0.8);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.6), inset 0 0 30px rgba(139, 92, 246, 0.3);
      animation-duration: 5s;
      animation-direction: reverse;
    }

    /* å†…ç¯ */
    .ring-3 {
      width: 120px;
      height: 120px;
      margin: -60px 0 0 -60px;
      border-color: rgba(236, 72, 153, 0.8);
      box-shadow: 0 0 30px rgba(236, 72, 153, 0.6), inset 0 0 30px rgba(236, 72, 153, 0.3);
      animation-duration: 2s;
    }

    /* ä¸­å¿ƒå‘å…‰çƒ */
    .core {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      margin: -30px 0 0 -30px;
      border-radius: 50%;
      background: radial-gradient(circle, #fff 0%, rgba(99, 102, 241, 0.8) 50%, transparent 100%);
      box-shadow: 0 0 40px rgba(99, 102, 241, 1), 0 0 60px rgba(139, 92, 246, 0.8);
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes rotate3d {
      0% {
        transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
      }
      100% {
        transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }

    /* è¿›åº¦æ¡ */
    .progress-container {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
      border-radius: 10px;
      width: 0%;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
      position: relative;
      overflow: hidden;
      transition: width 0.3s ease-out;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 200%; }
    }

    /* Logo æ ·å¼ */
    .logo-container {
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap:0px;
      animation: fadeInDown 0.8s ease-out;
    }

    .logo-image {
      height: 320px;
      object-fit: contain;
      filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.6));
      animation: logoFloat 3s ease-in-out infinite;
    }
    
    /* ä¸“é—¨é’ˆå¯¹ Flutter Logo çš„æ ·å¼ */
    .flutter-logo {
      height: 130px;
    }

    .app-title {
      color: #fff;
      font-size: 62px;
      font-weight: 600;
      text-align: center;
      letter-spacing: 1px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 2s infinite ease-in-out;
    }

    @keyframes logoFloat {
      0%, 100% {
        transform: translateY(0px) rotate(0deg);
      }
      50% {
        transform: translateY(-10px) rotate(5deg);
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes titleGlow {
      0%, 100% {
        filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
      }
      50% {
        filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.8));
      }
    }

    /* åŠ è½½æ–‡æœ¬ */
    .loading-text {
      color: #fff;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-top: -10px;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
      animation: textGlow 2s infinite ease-in-out;
    }

    .loading-subtext {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      margin-top: 10px;
      letter-spacing: 1px;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 300px;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .progress-percent {
      font-weight: 700;
      color: #6366f1;
      font-size: 16px;
      text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
    }

    .loading-stats {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
      letter-spacing: 0.5px;
    }

    @keyframes textGlow {
      0%, 100% {
        text-shadow: 0 0 20px rgba(99, 102, 241, 0.8), 0 0 30px rgba(139, 92, 246, 0.6);
      }
      50% {
        text-shadow: 0 0 30px rgba(99, 102, 241, 1), 0 0 40px rgba(139, 92, 246, 0.8), 0 0 50px rgba(236, 72, 153, 0.6);
      }
    }

    /* è£…é¥°æ€§å…‰çº¿ */
    .light-beam {
      position: absolute;
      width: 2px;
      height: 100px;
      background: linear-gradient(180deg, transparent, rgba(99, 102, 241, 0.8), transparent);
      animation: beam 3s infinite ease-in-out;
    }

    .light-beam:nth-child(1) {
      top: 10%;
      left: 20%;
      animation-delay: 0s;
    }

    .light-beam:nth-child(2) {
      top: 30%;
      right: 15%;
      animation-delay: 0.5s;
    }

    .light-beam:nth-child(3) {
      bottom: 20%;
      left: 30%;
      animation-delay: 1s;
    }

    .light-beam:nth-child(4) {
      bottom: 10%;
      right: 25%;
      animation-delay: 1.5s;
    }

    @keyframes beam {
      0%, 100% {
        opacity: 0;
        transform: translateY(0) scaleY(0.5);
      }
      50% {
        opacity: 1;
        transform: translateY(-20px) scaleY(1);
      }
    }
  </style>
</head>
<body>
  <!-- åŠ è½½åŠ¨ç”»å®¹å™¨ -->
  <div id="loading-container">
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- è£…é¥°å…‰æŸ -->
    <div class="light-beam"></div>
    <div class="light-beam"></div>
    <div class="light-beam"></div>
    <div class="light-beam"></div>
    
    <!-- ä¸»åŠ è½½å™¨ -->
    <div class="loader-wrapper">
      <!-- Logo å’Œæ ‡é¢˜ -->
      <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <!-- åŒLogo -->
        <div class="logo-container">
          <!-- Serverpod Logo -->
          <img src="assets/images/serverpod_illustration.webp" 
               alt="Serverpod Logo" 
               class="logo-image"
               onerror="this.style.display='none'">

          <!-- Flutter Logo -->
          <img src="assets/images/flutter_illustration.png" 
               alt="Flutter Logo" 
               class="logo-image flutter-logo"
               onerror="this.style.display='none'">
        </div>
        
        <!-- æ ‡é¢˜ -->
        <h1 class="app-title">Serverpod + Flutter Web Admin</h1>
      </div>
      
      <!-- 3Dæ—‹è½¬ç¯ -->
      <div class="rings-container">
        <div class="ring ring-1"></div>
        <div class="ring ring-2"></div>
        <div class="ring ring-3"></div>
        <div class="core"></div>
      </div>
      
      <!-- è¿›åº¦æ¡ -->
      <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-info">
          <span class="progress-percent" id="progress-percent">0%</span>
          <span class="loading-stats" id="loading-stats">åˆå§‹åŒ–ä¸­...</span>
        </div>
      </div>
      
      <!-- åŠ è½½æ–‡æœ¬ -->
      <div style="text-align: center;">
        <div class="loading-text">æ­£åœ¨åŠ è½½ä¸­...</div>
        <div class="loading-subtext">ç²¾å½©å³å°†å‘ˆç°</div>
      </div>
    </div>
  </div>

  <!-- ç²’å­åŠ¨ç”»è„šæœ¬ -->
  <script>
    (function() {
      const canvas = document.getElementById('particles-canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const particles = [];
      const particleCount = 80;
      
      class Particle {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.size = Math.random() * 2 + 0.5;
          this.speedX = Math.random() * 0.5 - 0.25;
          this.speedY = Math.random() * 0.5 - 0.25;
          this.opacity = Math.random() * 0.4 + 0.6;
          this.color = ['#8b92ff', '#a78bff', '#ff6bb5'][Math.floor(Math.random() * 3)];
        }
        
        update() {
          this.x += this.speedX;
          this.y += this.speedY;
          
          if (this.x > canvas.width) this.x = 0;
          if (this.x < 0) this.x = canvas.width;
          if (this.y > canvas.height) this.y = 0;
          if (this.y < 0) this.y = canvas.height;
        }
        
        draw() {
          ctx.fillStyle = this.color;
          ctx.globalAlpha = this.opacity;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      function init() {
        for (let i = 0; i < particleCount; i++) {
          particles.push(new Particle());
        }
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.globalAlpha = 1;
        
        particles.forEach(particle => {
          particle.update();
          particle.draw();
        });
        
        // ç»˜åˆ¶è¿çº¿
        ctx.globalAlpha = 0.3;
        for (let i = 0; i < particles.length; i++) {
          for (let j = i + 1; j < particles.length; j++) {
            const dx = particles[i].x - particles[j].x;
            const dy = particles[i].y - particles[j].y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < 120) {
              ctx.strokeStyle = '#8b92ff';
              ctx.lineWidth = 0.8;
              ctx.beginPath();
              ctx.moveTo(particles[i].x, particles[i].y);
              ctx.lineTo(particles[j].x, particles[j].y);
              ctx.stroke();
            }
          }
        }
        
        requestAnimationFrame(animate);
      }
      
      init();
      animate();
      
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
    })();
  </script>

  <!-- åŠ è½½è¿›åº¦ç›‘æ§è„šæœ¬ -->
  <script>
    (function() {
      console.log('='.repeat(60));
      console.log('ğŸš€ Flutter Web åº”ç”¨åŠ è½½å¼€å§‹');
      console.log('='.repeat(60));
      
      const progressBar = document.getElementById('progress-bar');
      const progressPercent = document.getElementById('progress-percent');
      const loadingStats = document.getElementById('loading-stats');
      
      let currentProgress = 0;
      let targetProgress = 0;
      let totalResources = 0;
      let loadedResources = 0;
      let totalSize = 0;
      let loadedSize = 0;
      const startTime = Date.now();
      
      // è¿›åº¦æ›´æ–°é˜Ÿåˆ—ç®¡ç†
      let lastStatusChangeTime = Date.now();
      let pendingUpdate = null;
      let isUpdating = false;
      const MIN_STATUS_DURATION = 300; // æ¯ä¸ªçŠ¶æ€æœ€å°‘æ˜¾ç¤º600msï¼Œç¡®ä¿å¯è¯»
      
      // æ›´æ–°è¿›åº¦æ¡çš„å‡½æ•°ï¼ˆå¸¦æœ€å°æ˜¾ç¤ºæ—¶é•¿æ§åˆ¶ï¼‰
      function updateProgress(progress, status) {
        const now = Date.now();
        const timeSinceLastChange = now - lastStatusChangeTime;
        
        // å¦‚æœæœ‰çŠ¶æ€æ–‡å­—å˜åŒ–
        if (status && status !== loadingStats.textContent) {
          // å¦‚æœè·ç¦»ä¸Šæ¬¡çŠ¶æ€å˜åŒ–æ—¶é—´å¤ªçŸ­ï¼Œå»¶è¿Ÿæ›´æ–°
          if (timeSinceLastChange < MIN_STATUS_DURATION && !isUpdating) {
            // ä¿å­˜å¾…æ›´æ–°çš„å†…å®¹
            const delay = MIN_STATUS_DURATION - timeSinceLastChange;
            
            // å¦‚æœæœ‰å¾…å¤„ç†çš„æ›´æ–°ï¼Œå…ˆå–æ¶ˆ
            if (pendingUpdate) {
              // å–æ¶ˆä¹‹å‰çš„å¾…æ›´æ–°
            }
            
            pendingUpdate = { progress, status };
            
            // è®¾ç½®å»¶è¿Ÿæ›´æ–°
            setTimeout(() => {
              if (pendingUpdate) {
                executeUpdate(pendingUpdate.progress, pendingUpdate.status);
                pendingUpdate = null;
              }
            }, delay);
            return;
          }
        }
        
        // ç«‹å³æ‰§è¡Œæ›´æ–°
        executeUpdate(progress, status);
      }
      
      // æ‰§è¡Œå®é™…çš„æ›´æ–°
      function executeUpdate(progress, status) {
        isUpdating = true;
        targetProgress = Math.min(progress, 95); // æœ€å¤šåˆ°95%ï¼Œç­‰å¾…FlutterçœŸæ­£åŠ è½½å®Œæˆ
        
        // å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡è¿›åº¦
        const smoothUpdate = () => {
          if (currentProgress < targetProgress) {
            currentProgress += (targetProgress - currentProgress) * 0.15;
            if (Math.abs(targetProgress - currentProgress) < 0.5) {
              currentProgress = targetProgress;
            }
            progressBar.style.width = currentProgress + '%';
            progressPercent.textContent = Math.floor(currentProgress) + '%';
            if (currentProgress < targetProgress) {
              requestAnimationFrame(smoothUpdate);
            }
          }
        };
        smoothUpdate();
        
        if (status && status !== loadingStats.textContent) {
          // ç›´æ¥æ›´æ–°æ–‡å­—ï¼Œæ— åŠ¨ç”»
          loadingStats.textContent = status;
          lastStatusChangeTime = Date.now();
        }
        
        isUpdating = false;
      }
      
      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }
      
      // ============================================
      // çœŸå®è¿›åº¦ç›‘æ§: èµ„æºåŠ è½½ (å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ)
      // ä½¿ç”¨ PerformanceObserver å®æ—¶ç›‘å¬ç½‘ç»œè¯·æ±‚
      // é™åˆ¶åœ¨30%-60%åŒºé—´ï¼Œé¿å…è·³è·ƒå¤ªå¿«
      // ============================================
      if (window.performance && window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.initiatorType === 'script' || entry.initiatorType === 'fetch') {
              totalResources++;
              
              // ä¼°ç®—å·²åŠ è½½çš„èµ„æº
              if (entry.responseEnd > 0) {
                loadedResources++;
                
                // å¦‚æœæœ‰transferSizeä¿¡æ¯ï¼Œç´¯åŠ å¤§å°
                if (entry.transferSize) {
                  loadedSize += entry.transferSize;
                  totalSize += entry.transferSize;
                }
                
                // è®¡ç®—è¿›åº¦ - èµ„æºåŠ è½½åªå 30%-60%çš„åŒºé—´ï¼ˆç¼©å°èŒƒå›´ï¼Œé¿å…è·³å¤ªå¿«ï¼‰
                const resourceRatio = loadedResources / Math.max(totalResources, 1);
                const resourceProgress = 30 + (resourceRatio * 30); // ä»30%åˆ°60%
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                
                let status = `åŠ è½½èµ„æºä¸­ (${loadedResources}/${totalResources})`;
                if (loadedSize > 0) {
                  status = `å·²åŠ è½½ ${formatBytes(loadedSize)} â€¢ ${elapsed}s`;
                }
                
                // åªæœ‰å½“æ–°è¿›åº¦å¤§äºå½“å‰è¿›åº¦æ—¶æ‰æ›´æ–°ï¼Œä¸”ä¸è¶…è¿‡60%
                if (resourceProgress > currentProgress && resourceProgress <= 60) {
                  updateProgress(resourceProgress, status);
                }
              }
            }
          }
        });
        
        observer.observe({ entryTypes: ['resource'] });
      }
      
      // ============================================
      // å¹¶è¡Œæœºåˆ¶1: ä¿åº•å®šæ—¶å™¨ï¼ˆé˜²æ­¢è¿›åº¦å¡ä½ï¼‰
      // åªæœ‰å½“å®é™…è¿›åº¦ä½äºç›®æ ‡æ—¶æ‰ä¼šæ›´æ–°
      // ============================================
      let hasStartedLoading = false;
      
      // é˜¶æ®µ1: åˆå§‹åŒ–ï¼ˆ0-10%ï¼‰
      setTimeout(() => {
        if (currentProgress < 10) {
          updateProgress(10, 'æ­£åœ¨åˆå§‹åŒ–...');
        }
      }, 200);
      
      // é˜¶æ®µ2: åŠ è½½å¼•æ“ï¼ˆ10-20%ï¼‰
      setTimeout(() => {
        if (currentProgress < 20) {
          updateProgress(20, 'åŠ è½½å¼•æ“ä¸­...');
        }
      }, 500);
      
      // é˜¶æ®µ3: åŠ è½½æ ¸å¿ƒæ¨¡å—ï¼ˆ20-30%ï¼‰
      setTimeout(() => {
        if (currentProgress < 30) {
          updateProgress(30, 'åŠ è½½æ ¸å¿ƒæ¨¡å—...');
        }
      }, 900);
      
      // èµ„æºåŠ è½½ä¼šåœ¨30%-60%åŒºé—´å®æ—¶æ›´æ–°ï¼ˆPerformanceObserverï¼‰
      
      // é˜¶æ®µ4: å‡†å¤‡æ¸²æŸ“ï¼ˆ60-65%ï¼‰
      setTimeout(() => {
        if (currentProgress < 65) {
          updateProgress(65, 'å‡†å¤‡æ¸²æŸ“...');
        }
      }, 2000);
      
      // é˜¶æ®µ5: åˆå§‹åŒ–æ¡†æ¶ï¼ˆ65-75%ï¼‰
      setTimeout(() => {
        if (currentProgress < 75) {
          updateProgress(75, 'åˆå§‹åŒ–æ¡†æ¶...');
        }
      }, 2500);
      
      // é˜¶æ®µ6: æ¸²æŸ“ç•Œé¢ï¼ˆ75-85%ï¼‰
      setTimeout(() => {
        if (currentProgress < 85) {
          updateProgress(85, 'æ¸²æŸ“ç•Œé¢...');
        }
      }, 3000);
      
      // é˜¶æ®µ7: å³å°†å®Œæˆï¼ˆ85-90%ï¼‰
      setTimeout(() => {
        if (currentProgress < 90) {
          updateProgress(90, 'å³å°†å®Œæˆ...');
        }
      }, 3500);
      
      // ============================================
      // å¹¶è¡Œæœºåˆ¶3: å­—ä½“åŠ è½½ç›‘æ§ï¼ˆç‹¬ç«‹è½®è¯¢ï¼‰
      // æ¯100msæ£€æŸ¥ä¸€æ¬¡ï¼Œä¸å…¶ä»–åŠ è½½è¿‡ç¨‹å¹¶è¡Œ
      // ============================================
      let fontsLoaded = false;
      let flutterReady = false;
      let wasmLoaded = false; // WASM åŠ è½½çŠ¶æ€æ ‡å¿—
      
      function checkAndHideLoader() {
        // åªæœ‰å½“ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶æ‰éšè—åŠ è½½å™¨ï¼š
        // 1. WASM æ–‡ä»¶åŠ è½½å®Œæˆ
        // 2. å­—ä½“åŠ è½½å®Œæˆ
        // 3. Flutter é¦–å¸§æ¸²æŸ“å®Œæˆ
        console.log(`[åŠ è½½å™¨] æ£€æŸ¥éšè—æ¡ä»¶ - WASMåŠ è½½: ${wasmLoaded}, Flutterå°±ç»ª: ${flutterReady}, å­—ä½“åŠ è½½: ${fontsLoaded}`);
        
        if (wasmLoaded && flutterReady && fontsLoaded) {
          console.log('[åŠ è½½å™¨] âœ… æ‰€æœ‰æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹éšè—åŠ è½½å™¨');
          updateProgress(100, 'åŠ è½½å®Œæˆï¼');
          progressPercent.textContent = '100%';
          
          setTimeout(() => {
            const loadingContainer = document.getElementById('loading-container');
            loadingContainer.classList.add('fade-out');
            console.log('[åŠ è½½å™¨] ğŸ‰ åŠ è½½å™¨æ·¡å‡ºåŠ¨ç”»å¼€å§‹');
            setTimeout(() => {
              loadingContainer.style.display = 'none';
              console.log('[åŠ è½½å™¨] ğŸ‰ åŠ è½½å™¨å·²å®Œå…¨éšè—ï¼Œåº”ç”¨å¯åŠ¨å®Œæˆï¼');
            }, 800);
          }, 300);
        } else {
          console.log('[åŠ è½½å™¨] â¸ï¸ ç­‰å¾…æ¡ä»¶æ»¡è¶³...');
        }
      }
      
      // ============================================
      // å¹¶è¡Œæœºåˆ¶3.5: WASM åŠ è½½ç›‘æ§ï¼ˆå…³é”®ä¿®å¤ï¼‰
      // ç›‘æ§ main.dart.wasm çš„å®é™…åŠ è½½çŠ¶æ€
      // ============================================
      
      // ä½¿ç”¨ PerformanceObserver ç›‘æ§ WASM æ–‡ä»¶åŠ è½½
      if (window.performance && window.PerformanceObserver) {
        const wasmObserver = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.name.includes('main.dart.wasm') || entry.name.includes('main.dart.mjs')) {
              console.log(`[WASM] ğŸ“¦ æ£€æµ‹åˆ°æ–‡ä»¶åŠ è½½: ${entry.name.split('/').pop()}`);
              console.log(`[WASM] ğŸ“Š å¤§å°: ${(entry.transferSize / 1024 / 1024).toFixed(2)} MB`);
              console.log(`[WASM] â±ï¸  è€—æ—¶: ${(entry.duration / 1000).toFixed(2)}s`);
              
              // æ£€æŸ¥æ˜¯å¦åŠ è½½å®Œæˆ
              if (entry.responseEnd > 0) {
                wasmLoaded = true;
                console.log('[WASM] âœ… WASM æ–‡ä»¶åŠ è½½å®Œæˆ');
                
                // WASM åŠ è½½å®Œæˆåï¼Œæ›´æ–°è¿›åº¦åˆ° 70%
                if (currentProgress < 70) {
                  updateProgress(70, 'WASM å¼•æ“åŠ è½½å®Œæˆ');
                }
                
                checkAndHideLoader();
              }
            }
          }
        });
        
        wasmObserver.observe({ entryTypes: ['resource'] });
      }
      
      // WASM è¶…æ—¶ä¿æŠ¤ï¼šå¦‚æœ 15 ç§’åè¿˜æ²¡åŠ è½½å®Œæˆï¼Œå¼ºåˆ¶æ ‡è®°ä¸ºå®Œæˆ
      // ï¼ˆ1.2MB çš„æ–‡ä»¶ï¼Œå³ä½¿æ…¢é€Ÿç½‘ç»œä¹Ÿåº”è¯¥èƒ½åœ¨ 15 ç§’å†…åŠ è½½å®Œï¼‰
      setTimeout(() => {
        if (!wasmLoaded) {
          console.warn('[WASM] â±ï¸ WASM åŠ è½½è¶…æ—¶(15ç§’)ï¼Œå¼ºåˆ¶æ ‡è®°ä¸ºå®Œæˆ');
          wasmLoaded = true;
          checkAndHideLoader();
        }
      }, 15000);
      
      // å­—ä½“åŠ è½½ç›‘æ§ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰- ç®€åŒ–ç‰ˆï¼Œæ›´å¯é 
      console.log('[å­—ä½“] ğŸ” å¼€å§‹ç›‘æ§å­—ä½“åŠ è½½...');
      if (document.fonts && document.fonts.ready) {
        console.log('[å­—ä½“] ğŸ“ Font Loading API å¯ç”¨ï¼Œç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ...');
        
        // ç­‰å¾…æ‰€æœ‰å­—ä½“åŠ è½½å®Œæˆ
        document.fonts.ready
          .then(() => {
            console.log('[å­—ä½“] âœ… æ‰€æœ‰å­—ä½“åŠ è½½å®Œæˆ');
            fontsLoaded = true;
            // å¦‚æœå½“å‰è¿›åº¦å·²ç»åˆ°90%ä»¥ä¸Šï¼Œæ˜¾ç¤ºå­—ä½“åŠ è½½å®ŒæˆçŠ¶æ€
            if (currentProgress >= 90) {
              updateProgress(95, 'å­—ä½“åŠ è½½å®Œæˆ');
            }
            checkAndHideLoader();
          })
          .catch((error) => {
            console.warn('[å­—ä½“] âš ï¸ å­—ä½“åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯åŠ¨åº”ç”¨:', error);
            fontsLoaded = true;
            checkAndHideLoader();
          });
        
        // è¶…æ—¶ä¿æŠ¤ï¼šæœ€å¤šç­‰å¾… 2 ç§’å­—ä½“åŠ è½½
        setTimeout(() => {
          if (!fontsLoaded) {
            console.warn('[å­—ä½“] â±ï¸ å­—ä½“åŠ è½½è¶…æ—¶(2ç§’)ï¼Œå¼ºåˆ¶ç»§ç»­');
            fontsLoaded = true;
            checkAndHideLoader();
          }
        }, 2000);
      } else {
        // æµè§ˆå™¨ä¸æ”¯æŒ Font Loading APIï¼Œç›´æ¥æ ‡è®°ä¸ºå®Œæˆ
        console.log('[å­—ä½“] â„¹ï¸ æµè§ˆå™¨ä¸æ”¯æŒ Font Loading APIï¼Œè·³è¿‡å­—ä½“æ£€æµ‹');
        fontsLoaded = true;
      }
      
      // ============================================
      // å¹¶è¡Œæœºåˆ¶4: Flutter å°±ç»ªäº‹ä»¶ï¼ˆå¼‚æ­¥å›è°ƒï¼‰
      // ç”± Flutter å¼•æ“åœ¨é¦–å¸§æ¸²æŸ“å®Œæˆåè§¦å‘
      // ä¸å…¶ä»–æ‰€æœ‰æœºåˆ¶å®Œå…¨å¹¶è¡Œæ‰§è¡Œ
      // ============================================
      window.addEventListener('flutter-first-frame', function() {
        console.log('[Flutter] âœ… é¦–å¸§æ¸²æŸ“å®Œæˆ');
        flutterReady = true;
        // Flutter æ¸²æŸ“å®Œæˆåï¼Œæ›´æ–°è¿›åº¦åˆ° 95%
        updateProgress(95, 'Flutter åˆå§‹åŒ–å®Œæˆ');
        checkAndHideLoader(); // å°è¯•éšè—ï¼ˆéœ€è¦åŒæ—¶æ»¡è¶³ fontsLoaded å’Œ wasmLoadedï¼‰
      });
      
      // ============================================
      // å…³é”®ä¿®å¤ï¼šå»¶é•¿ Flutter è¶…æ—¶ä¿æŠ¤æ—¶é—´
      // å¦‚æœ 20 ç§’å Flutter è¿˜æ²¡è§¦å‘ first-frameï¼Œå¼ºåˆ¶æ ‡è®°ä¸ºå°±ç»ª
      // ï¼ˆå¿…é¡»ç»™ WASM è¶³å¤Ÿçš„åŠ è½½æ—¶é—´ï¼‰
      // ============================================
      setTimeout(() => {
        if (!flutterReady) {
          console.warn('[Flutter] â±ï¸ Flutter åˆå§‹åŒ–è¶…æ—¶(20ç§’)ï¼Œå¼ºåˆ¶æ ‡è®°ä¸ºå°±ç»ª');
          flutterReady = true;
          checkAndHideLoader();
        }
      }, 20000);
      
      // è¶…æ—¶ä¿æŠ¤ï¼šå¦‚æœ30ç§’è¿˜æ²¡åŠ è½½å®Œæˆï¼Œå¼ºåˆ¶æ˜¾ç¤ºé«˜è¿›åº¦
      setTimeout(() => {
        if (currentProgress < 90) {
          updateProgress(90, 'æ­£åœ¨å®Œæˆæœ€åæ­¥éª¤...');
        }
      }, 30000);
      
    })();
  </script>

  <!-- CanvasKit æ™ºèƒ½ CDN é™çº§åŠ è½½ç­–ç•¥ï¼ˆä¹è§‚åŠ è½½æ¨¡å¼ï¼‰-->
  <script>
    (function() {
      // CDN åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
      const CDN_SOURCES = [
        'https://unpkg.com/canvaskit-wasm@0.40.0/bin/',           // ä¼˜å…ˆä½¿ç”¨ unpkgï¼ˆé€šå¸¸æ›´å¿«ï¼‰
        'https://cdn.jsdelivr.net/npm/canvaskit-wasm@0.40.0/bin/', // å¤‡ç”¨ jsdelivr
        '/canvaskit/'                                               // æœ€åä½¿ç”¨æœ¬åœ°æ–‡ä»¶
      ];
      
      let currentCdnIndex = 0;
      let cdnSwitchCount = 0; // é˜²æ­¢æ— é™å¾ªç¯åˆ‡æ¢
      const MAX_CDN_SWITCHES = 3;
      
      // ä» localStorage è¯»å–ä¸Šæ¬¡æˆåŠŸçš„ CDN
      try {
        const savedIndex = localStorage.getItem('canvaskit_cdn_index');
        if (savedIndex !== null) {
          const index = parseInt(savedIndex, 10);
          if (index >= 0 && index < CDN_SOURCES.length) {
            currentCdnIndex = index;
            console.log(`[CanvasKit] ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸçš„ CDN ${index + 1}: ${CDN_SOURCES[index]}`);
          }
        }
      } catch (e) {
        // localStorage å¯èƒ½è¢«ç¦ç”¨ï¼Œå¿½ç•¥é”™è¯¯
      }
      
      // ä¿å­˜ CDN é…ç½®åˆ°å…¨å±€å˜é‡ï¼Œä¾› Flutter æ–° API ä½¿ç”¨
      const currentCdnUrl = CDN_SOURCES[currentCdnIndex];
      window._canvasKitBaseUrl = currentCdnUrl;
      console.log(`[CanvasKit] é…ç½®åŠ è½½æº: ${currentCdnUrl}`);
      
      // ç›‘å¬ CanvasKit åŠ è½½é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢ CDN
      window.addEventListener('error', function(event) {
        const target = event.target;
        
        // æ£€æµ‹æ˜¯å¦æ˜¯ CanvasKit ç›¸å…³èµ„æºåŠ è½½å¤±è´¥
        if (target && (target.src || target.href)) {
          const url = target.src || target.href;
          if (url.includes('canvaskit') || url.includes('skwasm')) {
            console.error('[CanvasKit] âŒ èµ„æºåŠ è½½å¤±è´¥:', url);
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§åˆ‡æ¢æ¬¡æ•°
            if (cdnSwitchCount >= MAX_CDN_SWITCHES) {
              console.error('[CanvasKit] âŒ è¶…è¿‡æœ€å¤§åˆ‡æ¢æ¬¡æ•°ï¼Œåœæ­¢å°è¯•');
              alert('åº”ç”¨åŠ è½½å¤±è´¥ï¼šCanvasKit æ¸²æŸ“å¼•æ“æ— æ³•åŠ è½½ã€‚\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•ã€‚');
              return;
            }
            
            // å¦‚æœè¿˜æœ‰å¤‡ç”¨ CDNï¼Œå°è¯•åˆ‡æ¢
            if (currentCdnIndex < CDN_SOURCES.length - 1) {
              currentCdnIndex++;
              cdnSwitchCount++;
              
              console.log(`[CanvasKit] ğŸ”„ åˆ‡æ¢åˆ° CDN ${currentCdnIndex + 1}/${CDN_SOURCES.length}: ${CDN_SOURCES[currentCdnIndex]}`);
              
              // æ¸…é™¤å¤±è´¥çš„ CDN è®°å½•
              try {
                localStorage.removeItem('canvaskit_cdn_index');
              } catch (e) {
                // å¿½ç•¥é”™è¯¯
              }
              
              // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
              setTimeout(() => {
                console.log('[CanvasKit] åˆ·æ–°é¡µé¢ä»¥ä½¿ç”¨æ–° CDN...');
                window.location.reload();
              }, 500);
            } else {
              console.error('[CanvasKit] âŒ æ‰€æœ‰ CDN æºéƒ½å·²å°è¯•ï¼Œæ— æ³•åŠ è½½ CanvasKit');
              alert('åº”ç”¨åŠ è½½å¤±è´¥ï¼šæ— æ³•è·å– CanvasKit æ¸²æŸ“å¼•æ“ã€‚\nå·²å°è¯•æ‰€æœ‰å¯ç”¨æºï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
            }
          }
        }
      }, true);
      
      // ç›‘å¬ Flutter é¦–å¸§æ¸²æŸ“å®Œæˆï¼ˆè¡¨ç¤º CanvasKit åŠ è½½æˆåŠŸï¼‰
      window.addEventListener('flutter-first-frame', function() {
        console.log('[CanvasKit] âœ… åŠ è½½æˆåŠŸ');
        // ä¿å­˜æˆåŠŸçš„ CDN åˆ° localStorage
        try {
          localStorage.setItem('canvaskit_cdn_index', currentCdnIndex.toString());
          console.log(`[CanvasKit] ğŸ’¾ å·²ä¿å­˜æˆåŠŸçš„ CDN ç´¢å¼•: ${currentCdnIndex}`);
        } catch (e) {
          // localStorage å¯èƒ½è¢«ç¦ç”¨ï¼Œå¿½ç•¥é”™è¯¯
        }
      });
      
    })();
  </script>

  <!-- å¢å¼ºç‰ˆ Service Worker æ³¨å†Œ -->
  <script>
    (function() {
      // å¼€å‘æ¨¡å¼ä¸‹æš‚æ—¶ç¦ç”¨ Service Worker,é¿å…ç¼“å­˜é—®é¢˜
      const isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      if (isDevMode) {
        console.log('[App] ğŸ”§ å¼€å‘æ¨¡å¼:ç¦ç”¨ Service Worker');
        // æ³¨é”€æ‰€æœ‰å·²å­˜åœ¨çš„ Service Worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
              registration.unregister();
              console.log('[App] å·²æ³¨é”€ Service Worker:', registration.scope);
            });
          });
        }
        return; // è·³è¿‡ Service Worker æ³¨å†Œ
      }
      
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // æ³¨å†Œè‡ªå®šä¹‰ Service Worker
          navigator.serviceWorker.register('/sw-config.js')
            .then(registration => {
              console.log('[App] Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
              
              // æ£€æŸ¥æ›´æ–°
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('[App] å‘ç°æ–°çš„ Service Worker');
                
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                    console.log('[App] æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œå»ºè®®åˆ·æ–°é¡µé¢');
                    // å¯é€‰ï¼šæ˜¾ç¤ºé€šçŸ¥æç¤ºç”¨æˆ·åˆ·æ–°
                    showUpdateNotification();
                  }
                });
              });
            })
            .catch(error => {
              console.warn('[App] Service Worker æ³¨å†Œå¤±è´¥:', error);
              // Service Worker å¤±è´¥ä¸å½±å“åº”ç”¨æ­£å¸¸è¿è¡Œ
            });
          
          // ç›‘å¬ Service Worker æ¶ˆæ¯
          navigator.serviceWorker.addEventListener('message', (event) => {
            console.log('[App] æ”¶åˆ° Service Worker æ¶ˆæ¯:', event.data);
            
            if (event.data.type === 'cache-cleared') {
              console.log('[App] ç¼“å­˜å·²æ¸…é™¤ï¼Œåˆ·æ–°é¡µé¢...');
              window.location.reload();
            }
            
            if (event.data.type === 'cache-stats') {
              console.log('[App] ç¼“å­˜ç»Ÿè®¡:', event.data.data);
            }
          });
        });
        
        // æä¾›å…¨å±€æ–¹æ³•ç”¨äºç¼“å­˜ç®¡ç†
        window.swUtils = {
          // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
          clearCache: async () => {
            const registration = await navigator.serviceWorker.ready;
            registration.active.postMessage('clearCache');
          },
          
          // è·å–ç¼“å­˜ç»Ÿè®¡
          getCacheStats: async () => {
            const registration = await navigator.serviceWorker.ready;
            registration.active.postMessage('getCacheStats');
          },
          
          // å¼ºåˆ¶æ›´æ–° Service Worker
          update: async () => {
            const registration = await navigator.serviceWorker.ready;
            await registration.update();
            console.log('[App] Service Worker å·²æ›´æ–°');
          },
          
          // å¸è½½ Service Worker
          unregister: async () => {
            const registration = await navigator.serviceWorker.ready;
            const success = await registration.unregister();
            if (success) {
              console.log('[App] Service Worker å·²å¸è½½');
              // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
              const cacheNames = await caches.keys();
              await Promise.all(cacheNames.map(name => caches.delete(name)));
              console.log('[App] æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤');
            }
            return success;
          },
        };
        
        // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥ï¼ˆå¯è‡ªå®šä¹‰æ ·å¼ï¼‰
        function showUpdateNotification() {
          // åˆ›å»ºé€šçŸ¥å…ƒç´ 
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            z-index: 10000;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
          `;
          
          notification.innerHTML = `
            <button id="close-notification-btn" style="
              position: absolute;
              top: 8px;
              right: 8px;
              background: transparent;
              border: none;
              color: rgba(255, 255, 255, 0.7);
              cursor: pointer;
              font-size: 18px;
              padding: 0;
              width: 24px;
              height: 24px;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
            " onmouseover="this.style.color='white'; this.style.transform='scale(1.1)'" 
               onmouseout="this.style.color='rgba(255, 255, 255, 0.7)'; this.style.transform='scale(1)'">
              âœ•
            </button>
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">ğŸ‰ æ–°ç‰ˆæœ¬å¯ç”¨</div>
              <div style="font-size: 12px; opacity: 0.9;">ç‚¹å‡»åˆ·æ–°ä»¥è·å–æœ€æ–°åŠŸèƒ½</div>
            </div>
            <button id="update-refresh-btn" style="
              background: white;
              color: #6366f1;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              font-size: 12px;
              transition: all 0.3s ease;
            ">åˆ·æ–°</button>
          `;
          
          // æ·»åŠ å…³é—­æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          const closeBtn = notification.querySelector('#close-notification-btn');
          closeBtn.addEventListener('click', () => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => notification.remove(), 300);
          });
          
          // æ·»åŠ åˆ·æ–°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
          const refreshBtn = notification.querySelector('#update-refresh-btn');
          refreshBtn.addEventListener('click', () => {
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            refreshBtn.disabled = true;
            refreshBtn.style.cursor = 'not-allowed';
            refreshBtn.style.opacity = '0.6';
            
            // æ·»åŠ åŠ è½½åŠ¨ç”»
            refreshBtn.innerHTML = `
              <span style="display: inline-block; animation: spin 1s linear infinite;">âŸ³</span>
              åˆ·æ–°ä¸­...
            `;
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            const spinStyle = document.createElement('style');
            spinStyle.textContent = `
              @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
              }
            `;
            document.head.appendChild(spinStyle);
            
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹å†åˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
            setTimeout(() => {
              window.location.reload();
            }, 300);
          });
          
          // æ·»åŠ åŠ¨ç”»
          const style = document.createElement('style');
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateX(400px); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `;
          document.head.appendChild(style);
          
          document.body.appendChild(notification);
          
          // 10ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => notification.remove(), 300);
          }, 10000);
        }
        
        console.log('[App] Service Worker æ”¯æŒå·²å¯ç”¨');
      } else {
        console.warn('[App] æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
      }
    })();
  </script>

  <!-- Flutter åˆå§‹åŒ–è„šæœ¬ -->
  <script>
    {{flutter_js}}
  </script>
  <script>
    {{flutter_build_config}}
  </script>
  
  <script>
    // èµ„æºåŠ è½½ç›‘æ§è„šæœ¬ - æ˜¾ç¤ºæ‰€æœ‰èµ„æºçš„åŠ è½½æ¥æºã€è€—æ—¶å’Œç¼“å­˜çŠ¶æ€
    (function() {
      console.log('%c[èµ„æºç›‘æ§] å¼€å§‹ç›‘æ§æ‰€æœ‰èµ„æºåŠ è½½...', 'color: #00ff00; font-weight: bold;');
      console.log('%c[ç¼“å­˜ç­–ç•¥] Flutter Web ä½¿ç”¨åŸºäºå†…å®¹å“ˆå¸Œçš„ç¼“å­˜ç­–ç•¥', 'color: #00aaff; font-weight: bold;');
      console.log('%c[ç¼“å­˜ç­–ç•¥] é¦–æ¬¡è®¿é—®ä¼šä¸‹è½½æ–‡ä»¶ï¼Œåç»­è®¿é—®å°†ä»æµè§ˆå™¨ç¼“å­˜åŠ è½½ï¼ˆæå¿«ï¼‰', 'color: #00aaff;');
      console.log('â”€'.repeat(60));
      
      let totalDownloaded = 0;
      let totalFromCache = 0;
      let downloadedSize = 0;
      
      // ç›‘å¬æ‰€æœ‰èµ„æºåŠ è½½
      if (window.performance && window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            // åªå…³æ³¨é‡è¦èµ„æº
            if (entry.name.includes('main.dart') || 
                entry.name.includes('canvaskit') || 
                entry.name.includes('skwasm') ||
                entry.initiatorType === 'script' ||
                entry.initiatorType === 'fetch') {
              
              const url = new URL(entry.name);
              const fileName = url.pathname.split('/').pop();
              
              // åˆ¤æ–­æ˜¯å¦ä»ç¼“å­˜åŠ è½½
              const isFromCache = entry.transferSize === 0 && entry.decodedBodySize > 0;
              const fileSize = entry.transferSize > 0 
                ? (entry.transferSize / 1024 / 1024).toFixed(2) + ' MB' 
                : (isFromCache ? 'ğŸ’¾ æµè§ˆå™¨ç¼“å­˜' : '(æœªçŸ¥)');
              
              const duration = (entry.duration / 1000).toFixed(2) + 's';
              
              // ç»Ÿè®¡
              if (isFromCache) {
                totalFromCache++;
              } else if (entry.transferSize > 0) {
                totalDownloaded++;
                downloadedSize += entry.transferSize;
              }
              
              // åˆ¤æ–­æ¥æº
              let source = '';
              if (url.hostname === window.location.hostname) {
                source = 'ğŸ  æœ¬åœ°æœåŠ¡å™¨ (' + url.hostname + ')';
              } else {
                source = 'ğŸŒ CDN (' + url.hostname + ')';
              }
              
              // ç¼“å­˜çŠ¶æ€æ ‡è¯†
              const cacheStatus = isFromCache ? 'ğŸ’¾ ç¼“å­˜å‘½ä¸­' : 'ğŸ“¥ ç½‘ç»œä¸‹è½½';
              
              console.log(`%c[èµ„æº] ${fileName}`, isFromCache ? 'color: #10b981; font-weight: bold;' : 'color: #6366f1; font-weight: bold;');
              console.log(`  ğŸ“ æ¥æº: ${source}`);
              console.log(`  ${isFromCache ? 'ğŸ’¾' : 'ğŸ“¦'} å¤§å°: ${fileSize}`);
              console.log(`  â±ï¸  è€—æ—¶: ${duration}`);
              console.log(`  ğŸ¯ çŠ¶æ€: ${cacheStatus}`);
              console.log(`  ğŸ”— å®Œæ•´URL: ${entry.name}`);
              console.log('â”€'.repeat(60));
            }
          }
        });
        
        observer.observe({ entryTypes: ['resource'] });
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        window.addEventListener('load', () => {
          setTimeout(() => {
            console.log('%c[ç»Ÿè®¡ä¿¡æ¯] èµ„æºåŠ è½½ç»Ÿè®¡', 'color: #f59e0b; font-weight: bold; font-size: 14px;');
            console.log(`  ğŸ“¥ ç½‘ç»œä¸‹è½½: ${totalDownloaded} ä¸ªæ–‡ä»¶`);
            console.log(`  ğŸ’¾ ç¼“å­˜å‘½ä¸­: ${totalFromCache} ä¸ªæ–‡ä»¶`);
            console.log(`  ğŸ“Š ä¸‹è½½å¤§å°: ${(downloadedSize / 1024 / 1024).toFixed(2)} MB`);
            console.log(`  ğŸš€ ç¼“å­˜æ•ˆç‡: ${totalFromCache > 0 ? ((totalFromCache / (totalDownloaded + totalFromCache)) * 100).toFixed(1) : 0}%`);
            console.log('â”€'.repeat(60));
            
            if (totalFromCache > 0) {
              console.log('%câœ… æµè§ˆå™¨ç¼“å­˜æ­£å¸¸å·¥ä½œï¼äºŒæ¬¡è®¿é—®é€Ÿåº¦å°†å¤§å¹…æå‡ï¼', 'color: #10b981; font-weight: bold; font-size: 14px;');
            } else {
              console.log('%câ„¹ï¸  é¦–æ¬¡è®¿é—®ï¼Œæ­£åœ¨å»ºç«‹ç¼“å­˜ã€‚ä¸‹æ¬¡è®¿é—®å°†ç›´æ¥ä»ç¼“å­˜åŠ è½½ã€‚', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
            }
          }, 2000);
        });
      }
    })();
  </script>
  
  <script>
    // Flutter å¼•æ“åˆå§‹åŒ–è„šæœ¬
    (function() {
      console.log('[Flutteråˆå§‹åŒ–] å¼€å§‹åˆå§‹åŒ–...');
      
      // ç­‰å¾… _flutter å¯¹è±¡å¯ç”¨
      let attempts = 0;
      const maxAttempts = 200; // 10ç§’è¶…æ—¶ (50ms * 200)
      
      const checkFlutter = setInterval(function() {
        attempts++;
        
        if (typeof _flutter !== 'undefined' && _flutter.loader) {
          clearInterval(checkFlutter);
          console.log('[Flutteråˆå§‹åŒ–] âœ… _flutter å¯¹è±¡å·²å°±ç»ª');
          
          // å¼€å§‹åŠ è½½ Flutter åº”ç”¨
          _flutter.loader.load({
            onEntrypointLoaded: async function(engineInitializer) {
              try {
                console.log('[Flutteråˆå§‹åŒ–] å…¥å£ç‚¹å·²åŠ è½½,åˆå§‹åŒ–å¼•æ“...');
                
                // é…ç½®å¼•æ“å‚æ•°
                const engineConfig = {
                  renderer: "canvaskit",
                  canvasKitBaseUrl: window._canvasKitBaseUrl || "https://unpkg.com/canvaskit-wasm@0.40.0/bin/"
                };
                
                console.log('[Flutteråˆå§‹åŒ–] å¼•æ“é…ç½®:', engineConfig);
                
                let appRunner = await engineInitializer.initializeEngine(engineConfig);
                
                console.log('[Flutteråˆå§‹åŒ–] å¼•æ“åˆå§‹åŒ–å®Œæˆ,è¿è¡Œåº”ç”¨...');
                await appRunner.runApp();
                console.log('[Flutteråˆå§‹åŒ–] âœ… åº”ç”¨å¯åŠ¨æˆåŠŸï¼');
                
              } catch (error) {
                console.error('[Flutteråˆå§‹åŒ–] âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åº”ç”¨åŠ è½½å¤±è´¥:\n' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
              }
            }
          });
        } else if (attempts >= maxAttempts) {
          clearInterval(checkFlutter);
          console.error('[Flutteråˆå§‹åŒ–] âŒ è¶…æ—¶: _flutter å¯¹è±¡æœªå°±ç»ª');
          alert('Flutter åŠ è½½è¶…æ—¶,è¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
      }, 50);
    })();
  </script>
</body>
</html>
