# Flutter Web CanvasKit ä¸ç¼“å­˜ç­–ç•¥è¯¦è§£

## ğŸ“¦ ä»€ä¹ˆæ˜¯ CanvasKitï¼Ÿ

**CanvasKit** æ˜¯ Flutter Web çš„æ¸²æŸ“å¼•æ“ï¼ŒåŸºäº **Skia å›¾å½¢å¼•æ“** çš„ WebAssembly (WASM) ç‰ˆæœ¬ã€‚

### æ ¸å¿ƒä½œç”¨

1. **é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“** - åœ¨æµè§ˆå™¨ä¸­æä¾›æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½
2. **è·¨å¹³å°ä¸€è‡´æ€§** - ç¡®ä¿ Webã€Androidã€iOS çš„æ¸²æŸ“æ•ˆæœå®Œå…¨ä¸€è‡´
3. **å®Œæ•´çš„ Flutter ç‰¹æ€§æ”¯æŒ** - æ”¯æŒæ‰€æœ‰ Flutter ç»„ä»¶å’ŒåŠ¨ç”»æ•ˆæœ

### æ–‡ä»¶ç»„æˆï¼ˆçº¦ 8-12MBï¼‰

```
canvaskit/
â”œâ”€â”€ canvaskit.wasm          # ä¸»æ¸²æŸ“å¼•æ“ (~2-3MB)
â”œâ”€â”€ canvaskit.js            # åŠ è½½å™¨å’Œæ¥å£
â”œâ”€â”€ skwasm.wasm             # Skia WebAssembly æ¨¡å—
â”œâ”€â”€ skwasm_heavy.wasm       # å®Œæ•´ç‰ˆ Skia (~6-8MB)
â””â”€â”€ chromium/               # Chromium ä¼˜åŒ–ç‰ˆæœ¬
    â”œâ”€â”€ canvaskit.wasm
    â””â”€â”€ canvaskit.js
```

## ğŸ”„ Flutter 3.35+ é‡è¦å˜åŒ–

### HTML æ¸²æŸ“å™¨å·²è¢«ç§»é™¤

ä» Flutter 3.35 å¼€å§‹ï¼Œ**HTML æ¸²æŸ“å™¨è¢«æ­£å¼ç§»é™¤**ï¼ŒCanvasKit æˆä¸º**å”¯ä¸€**çš„æ¸²æŸ“é€‰æ‹©ã€‚

#### ä¹‹å‰ï¼ˆFlutter < 3.35ï¼‰
```bash
# æœ‰ä¸‰ç§é€‰æ‹©
flutter build web --web-renderer html       # HTML æ¸²æŸ“ï¼ˆè½»é‡ä½†æ€§èƒ½å·®ï¼‰
flutter build web --web-renderer canvaskit  # CanvasKit æ¸²æŸ“ï¼ˆæ€§èƒ½å¥½ä½†ä½“ç§¯å¤§ï¼‰
flutter build web --web-renderer auto       # è‡ªåŠ¨é€‰æ‹©
```

#### ç°åœ¨ï¼ˆFlutter 3.35+ï¼‰
```bash
# åªæœ‰ä¸€ç§æ–¹å¼
flutter build web  # é»˜è®¤ä¸”å”¯ä¸€ä½¿ç”¨ CanvasKit

# ä»¥ä¸‹å‘½ä»¤å·²åºŸå¼ƒ
flutter build web --web-renderer html      # âŒ æŠ¥é”™
flutter build web --web-renderer auto      # âš ï¸ è¢«å¿½ç•¥
flutter build web --web-renderer canvaskit # âš ï¸ è¢«å¿½ç•¥ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
```

### ä¸ºä»€ä¹ˆç§»é™¤ HTML æ¸²æŸ“å™¨ï¼Ÿ

å®˜æ–¹ç»™å‡ºçš„ç†ç”±ï¼š

1. **ç»´æŠ¤æˆæœ¬é«˜** - éœ€è¦åŒæ—¶ç»´æŠ¤ä¸¤å¥—æ¸²æŸ“ç³»ç»Ÿ
2. **åŠŸèƒ½å·®å¼‚** - HTML æ¸²æŸ“å™¨ä¸æ”¯æŒæŸäº›é«˜çº§ç‰¹æ€§
3. **æ€§èƒ½é—®é¢˜** - HTML æ¸²æŸ“å™¨æ€§èƒ½è¿œä¸å¦‚ CanvasKit
4. **ä¸€è‡´æ€§é—®é¢˜** - ä¸¤ç§æ¸²æŸ“å™¨çš„è§†è§‰æ•ˆæœå­˜åœ¨å·®å¼‚

## ğŸŒ æµè§ˆå™¨åŠ è½½æœºåˆ¶

### é¦–æ¬¡è®¿é—®æ—¶

```
ç”¨æˆ·è®¿é—®åº”ç”¨
    â†“
åŠ è½½ index.html (å‡  KB)
    â†“
åŠ è½½ main.dart.js (å‡ ç™¾ KB - å‡  MB)
    â†“
å¼€å§‹ä¸‹è½½ CanvasKit (8-12 MB) â† è€—æ—¶æœ€é•¿ï¼
    â†“
    â”œâ”€ canvaskit.wasm (2-3 MB)
    â”œâ”€ skwasm.wasm
    â””â”€ skwasm_heavy.wasm (6-8 MB)
    â†“
CanvasKit åˆå§‹åŒ–
    â†“
åº”ç”¨æ¸²æŸ“å®Œæˆ
```

**é—®é¢˜**: æ¯æ¬¡è®¿é—®éƒ½éœ€è¦ä¸‹è½½ CanvasKitï¼Œæµªè´¹æ—¶é—´å’Œå¸¦å®½ï¼

### ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜å

```
é¦–æ¬¡è®¿é—®ï¼šä¸‹è½½å¹¶ç¼“å­˜ CanvasKit
åç»­è®¿é—®ï¼šä»æµè§ˆå™¨ç¼“å­˜ç›´æ¥åŠ è½½ï¼ˆ< 50msï¼‰âœ¨
```

**ä½†æµè§ˆå™¨ç¼“å­˜çš„é—®é¢˜:**
- ä¸ç¨³å®šï¼ˆå¯èƒ½è¢«æ¸…é™¤ï¼‰
- ç¼“å­˜ç­–ç•¥ä¸å¯æ§
- ç¦»çº¿ä¸å¯ç”¨

### ä½¿ç”¨ Service Worker å

```
é¦–æ¬¡è®¿é—®ï¼š
    ä¸‹è½½ CanvasKit â†’ Service Worker æ™ºèƒ½ç¼“å­˜ï¼ˆ1å¹´æœ‰æ•ˆæœŸï¼‰

åç»­è®¿é—®ï¼š
    è¯·æ±‚ CanvasKit â†’ Service Worker æ‹¦æˆª â†’ ç›´æ¥è¿”å›ç¼“å­˜ âœ…
    (ä¸å‘é€ç½‘ç»œè¯·æ±‚ï¼)

ç¦»çº¿è®¿é—®ï¼š
    Service Worker æä¾›å®Œæ•´çš„ç¦»çº¿æ”¯æŒ âœ…
```

## ğŸ’¡ ä¸ºä»€ä¹ˆ Service Worker å¦‚æ­¤é‡è¦ï¼Ÿ

### Flutter 3.35+ çš„ç°å®

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| **CanvasKit å¿…é¡»ä¸‹è½½** | æ²¡æœ‰ HTML æ¸²æŸ“å™¨å¯ä»¥é€€è·¯äº† |
| **æ–‡ä»¶ä½“ç§¯å¤§** | 8-12MBï¼Œç§»åŠ¨ç½‘ç»œä¸‹è½½è¾ƒæ…¢ |
| **é‡å¤ä¸‹è½½æµªè´¹** | æ¯ä¸ªç”¨æˆ·æ¯æ¬¡è®¿é—®éƒ½ä¸‹è½½ä¸€é |
| **ç¦»çº¿ä¸å¯ç”¨** | æ²¡æœ‰ç½‘ç»œå°±æ— æ³•ä½¿ç”¨ |

### Service Worker çš„è§£å†³æ–¹æ¡ˆ

âœ… **é¦–æ¬¡åŠ è½½åæ°¸ä¹…ç¼“å­˜**ï¼ˆ1å¹´æœ‰æ•ˆæœŸï¼‰  
âœ… **é›¶ç½‘ç»œè¯·æ±‚**ï¼ˆåç»­è®¿é—®ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼‰  
âœ… **ç¦»çº¿å¯ç”¨**ï¼ˆå®Œæ•´çš„ç¦»çº¿æ”¯æŒï¼‰  
âœ… **èŠ‚çœå¸¦å®½**ï¼ˆå¯¹ç”¨æˆ·å’ŒæœåŠ¡å™¨éƒ½æœ‰åˆ©ï¼‰  
âœ… **æå‡ä½“éªŒ**ï¼ˆåŠ è½½é€Ÿåº¦æå‡ 70%+ï¼‰

## ğŸ“Š å®é™…æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ 1: é¦–æ¬¡è®¿é—®ï¼ˆ3G ç½‘ç»œï¼‰

**æ—  Service Worker:**
```
æ€»åŠ è½½æ—¶é—´: ~15 ç§’
  - HTML: 0.2s
  - main.dart.js: 3s
  - CanvasKit: 10s â† å¤§éƒ¨åˆ†æ—¶é—´ï¼
  - å…¶ä»–èµ„æº: 2s
```

**æœ‰ Service Worker:**
```
é¦–æ¬¡è®¿é—®æ—¶é—´ç›¸åŒ: ~15 ç§’
ï¼ˆä½†ä¸‹è½½çš„åŒæ—¶å·²ç»åœ¨ç¼“å­˜äº†ï¼‰
```

### åœºæ™¯ 2: å†æ¬¡è®¿é—®

**æ—  Service Worker:**
```
æ€»åŠ è½½æ—¶é—´: ~8 ç§’
  - HTML: 0.2s (æµè§ˆå™¨ç¼“å­˜)
  - main.dart.js: 2s (æµè§ˆå™¨ç¼“å­˜)
  - CanvasKit: 5s â† ä»éœ€ä» CDN ä¸‹è½½ï¼
  - å…¶ä»–èµ„æº: 0.8s
```

**æœ‰ Service Worker:**
```
æ€»åŠ è½½æ—¶é—´: < 1 ç§’ âœ¨
  - HTML: 0.1s (Service Worker ç¼“å­˜)
  - main.dart.js: 0.3s (Service Worker ç¼“å­˜)
  - CanvasKit: 0.05s (Service Worker ç¼“å­˜ï¼Œé›¶ç½‘ç»œè¯·æ±‚ï¼)
  - å…¶ä»–èµ„æº: 0.1s
```

**æ€§èƒ½æå‡: 88%ï¼** ğŸš€

### åœºæ™¯ 3: ç¦»çº¿è®¿é—®

**æ—  Service Worker:**
```
âŒ å®Œå…¨æ— æ³•ä½¿ç”¨
```

**æœ‰ Service Worker:**
```
âœ… æ­£å¸¸ä½¿ç”¨ï¼ˆé™¤äº†éœ€è¦ç½‘ç»œçš„ API è¯·æ±‚ï¼‰
åŠ è½½æ—¶é—´: < 1 ç§’
```

## ğŸ”§ æˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆ

### 1. CDN åŠ é€Ÿ

```javascript
// web/index.html
window.flutterConfiguration = {
  canvasKitBaseUrl: "https://cdn.jsdelivr.net/npm/canvaskit-wasm@0.40.0/bin/"
};
```

**ä¼˜ç‚¹:**
- ä½¿ç”¨å›½å†…å¯è®¿é—®çš„ CDN
- å…¨çƒåŠ é€ŸèŠ‚ç‚¹
- è‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„æœåŠ¡å™¨

### 2. Service Worker æ™ºèƒ½ç¼“å­˜

```javascript
// web/sw-config.js
const CACHE_STRATEGIES = {
  canvaskit: {
    strategy: 'cache-first',     // ç¼“å­˜ä¼˜å…ˆ
    maxAge: 365 * 24 * 60 * 60 * 1000,  // 1å¹´æœ‰æ•ˆæœŸ
  },
  // ... å…¶ä»–ç­–ç•¥
};
```

**ç¼“å­˜ç­–ç•¥:**

| èµ„æºç±»å‹ | ç­–ç•¥ | æœ‰æ•ˆæœŸ | è¯´æ˜ |
|---------|------|--------|------|
| **CanvasKit** | Cache-First | 1å¹´ | ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œç½‘ç»œå¤±è´¥ä¹Ÿèƒ½ç”¨ |
| **CDN èµ„æº** | Cache-First | 30å¤© | å­—ä½“ã€å›¾ç‰‡ç­‰é™æ€èµ„æº |
| **åº”ç”¨ä»£ç ** | Network-First | 7å¤© | ç¡®ä¿ç”¨æˆ·è·å–æœ€æ–°ç‰ˆæœ¬ |
| **API å“åº”** | Network-First | 5åˆ†é’Ÿ | æ•°æ®å®æ—¶æ€§ä¼˜å…ˆ |

### 3. æ›´æ–°é€šçŸ¥æœºåˆ¶

```javascript
// æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨æç¤ºç”¨æˆ·
showUpdateNotification(); // "ğŸ‰ æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œç‚¹å‡»åˆ·æ–°"
```

## ğŸ¯ å®æ–½æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡åŠ è½½ | 15s (3G) | 15s | - |
| äºŒæ¬¡åŠ è½½ | 8s | < 1s | **88%** |
| ç¦»çº¿å¯ç”¨ | âŒ | âœ… | - |
| å¸¦å®½æ¶ˆè€— | æ¯æ¬¡ 12MB | é¦–æ¬¡ 12MB + åç»­ 0MB | **100%** |

### æœåŠ¡å™¨å‹åŠ›é™ä½

å‡è®¾ 1000 ä¸ªç”¨æˆ·ï¼Œæ¯äººè®¿é—® 10 æ¬¡ï¼š

**æ—  Service Worker:**
```
æ€»ä¸‹è½½é‡ = 1000 ç”¨æˆ· Ã— 10 æ¬¡ Ã— 12MB = 120 GB
```

**æœ‰ Service Worker:**
```
æ€»ä¸‹è½½é‡ = 1000 ç”¨æˆ· Ã— 1 æ¬¡ Ã— 12MB = 12 GB
èŠ‚çœå¸¦å®½: 108 GB (90%)
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é›†æˆï¼ˆå·²å®Œæˆï¼‰

æœ¬é¡¹ç›®å·²ç»é›†æˆäº†å®Œæ•´çš„ Service Worker ä¼˜åŒ–æ–¹æ¡ˆï¼š

- âœ… `web/sw-config.js` - Service Worker é…ç½®
- âœ… `web/index.html` - CDN é…ç½®å’Œæ³¨å†Œä»£ç 
- âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- âœ… æ›´æ–°é€šçŸ¥æœºåˆ¶
- âœ… ç¦»çº¿æ”¯æŒ

### 2. æ„å»ºå’Œéƒ¨ç½²

```bash
# 1. æ„å»ºåº”ç”¨
flutter build web

# 2. å¤åˆ¶ Service Worker åˆ°æ„å»ºç›®å½•
cp web/sw-config.js build/web/sw-config.js

# 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
# ç¡®ä¿ sw-config.js å¯è¢«è®¿é—®
```

### 3. éªŒè¯æ•ˆæœ

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
./test_service_worker.sh

# æˆ–æ‰‹åŠ¨æµ‹è¯•ï¼š
# 1. é¦–æ¬¡è®¿é—®ï¼Œè§‚å¯Ÿ Network æ ‡ç­¾
# 2. åˆ·æ–°é¡µé¢ï¼Œcanvaskit.wasm åº”æ˜¾ç¤º "(disk cache)"
# 3. å¼€å¯ç¦»çº¿æ¨¡å¼ï¼Œåº”ç”¨ä»å¯æ­£å¸¸åŠ è½½
```

### 4. ç®¡ç†ç¼“å­˜

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼š

```javascript
// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
window.swUtils.getCacheStats();

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
await window.swUtils.clearCache();

// æ›´æ–° Service Worker
await window.swUtils.update();
```

## ğŸ“ æ€»ç»“

### CanvasKit çš„å¿…ç„¶æ€§

- Flutter 3.35+ ç§»é™¤äº† HTML æ¸²æŸ“å™¨
- CanvasKit æˆä¸º**å”¯ä¸€é€‰æ‹©**
- å¿…é¡»æ¥å— 8-12MB çš„åˆå§‹ä¸‹è½½

### Service Worker çš„é‡è¦æ€§

- **ä¸æ˜¯å¯é€‰é¡¹ï¼Œè€Œæ˜¯å¿…éœ€å“**
- å¯ä»¥å°†åç»­åŠ è½½é€Ÿåº¦æå‡ 88%
- èŠ‚çœ 90% çš„å¸¦å®½
- æä¾›ç¦»çº¿è®¿é—®èƒ½åŠ›

### æœ€ä½³å®è·µ

1. âœ… ä½¿ç”¨ CDN åŠ é€Ÿ CanvasKit ä¸‹è½½
2. âœ… å®æ–½ Service Worker æ™ºèƒ½ç¼“å­˜
3. âœ… è®¾ç½®åˆç†çš„ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆ1å¹´ï¼‰
4. âœ… æä¾›ç¼“å­˜ç®¡ç†å·¥å…·ç»™ç”¨æˆ·
5. âœ… åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨ Gzip/Brotli å‹ç¼©

### æŠ•å…¥äº§å‡ºæ¯”

| æŠ•å…¥ | äº§å‡º |
|------|------|
| 2 ä¸ªæ–‡ä»¶ï¼ˆsw-config.js + ä¿®æ”¹ index.htmlï¼‰| 88% åŠ è½½é€Ÿåº¦æå‡ |
| ä¸€æ¬¡é…ç½® | æ°¸ä¹…å—ç›Š |
| é›¶è¿ç»´æˆæœ¬ | 90% å¸¦å®½èŠ‚çœ |

**ç»“è®º**: Service Worker æ˜¯ Flutter 3.35+ Web åº”ç”¨çš„**å¿…å¤‡ä¼˜åŒ–**ï¼ŒæŠ•å…¥äº§å‡ºæ¯”æé«˜ï¼

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [SERVICE_WORKER_GUIDE.md](./SERVICE_WORKER_GUIDE.md) - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
- [Flutter Web æ¸²æŸ“å™¨å˜åŒ–](https://docs.flutter.dev/platform-integration/web/renderers)
- [Service Worker API](https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API)
- [CanvasKit å®˜æ–¹æ–‡æ¡£](https://skia.org/docs/user/modules/canvaskit/)

